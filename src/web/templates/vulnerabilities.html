{% extends "base.html" %}

{% block page_actions %}
<div class="page-actions">
    <button class="btn btn-warning">New Only ({{ severity_counts.get('new', 0) }})</button>
    <button class="btn btn-primary" hx-get="/api/vulnerabilities" hx-target="#vulns-table" hx-swap="innerHTML">
        Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Severity Summary -->
<div class="stats-grid small">
    <div class="stat-card critical">
        <h3>{{ severity_counts.get('critical', 0) }}</h3>
        <p>Critical</p>
    </div>
    <div class="stat-card high">
        <h3>{{ severity_counts.get('high', 0) }}</h3>
        <p>High</p>
    </div>
    <div class="stat-card medium">
        <h3>{{ severity_counts.get('medium', 0) }}</h3>
        <p>Medium</p>
    </div>
    <div class="stat-card low">
        <h3>{{ severity_counts.get('low', 0) }}</h3>
        <p>Low</p>
    </div>
    <div class="stat-card info">
        <h3>{{ severity_counts.get('info', 0) }}</h3>
        <p>Info</p>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="filter-bar">
        <select id="severity-filter" class="form-select">
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="info">Info</option>
        </select>
        <select id="reported-filter" class="form-select">
            <option value="">All Status</option>
            <option value="false">Unreported Only</option>
            <option value="true">Reported Only</option>
        </select>
        <label class="checkbox-label">
            <input type="checkbox" id="new-only-filter"> New Only
        </label>
    </div>
</div>

<!-- Vulnerabilities Table -->
<div class="card">
    <div id="vulns-table">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Template</th>
                    <th>Severity</th>
                    <th>Asset</th>
                    <th>Program</th>
                    <th>Status</th>
                    <th>Discovered</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for vuln in vulnerabilities %}
                <tr class="{% if not vuln.is_reported %}new-vuln{% endif %}">
                    <td>
                        <strong>{{ vuln.template_name }}</strong>
                        {% if vuln.matcher_name %}
                        <br><small class="text-muted">{{ vuln.matcher_name }}</small>
                        {% endif %}
                    </td>
                    <td><span class="severity-badge {{ vuln.severity }}">{{ vuln.severity|upper }}</span></td>
                    <td>
                        <code>{{ vuln.asset_value }}</code>
                        <br><small class="text-muted">{{ vuln.asset_type }}</small>
                    </td>
                    <td>{{ vuln.program_name }}</td>
                    <td>
                        {% if vuln.is_reported %}
                        <span class="status-badge reported">Reported</span>
                        {% else %}
                        <span class="status-badge unreported">Unreported</span>
                        {% endif %}
                    </td>
                    <td>{{ vuln.discovered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" title="View Details" onclick="viewVulnDetails({{ vuln.id }})">
                                üëÅÔ∏è
                            </button>
                            {% if not vuln.is_reported %}
                            <button class="btn-icon" title="Mark as Reported"
                                    hx-post="/api/vulnerabilities/mark-reported"
                                    hx-vals='{"vulnerability_ids": [{{ vuln.id }}]}'
                                    hx-swap="none">
                                ‚úÖ
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if not vulnerabilities %}
        <div class="empty-state">
            <p>No vulnerabilities found. Run some scans to discover vulnerabilities!</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function viewVulnDetails(vulnId) {
    // Future: Open modal with full vulnerability details
    alert('Vulnerability details modal (coming soon): ID ' + vulnId);
}
</script>
{% endblock %}
